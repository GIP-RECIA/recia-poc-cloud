From 17a24e59388ca7180b58ffaf9191a1184e1062bb Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=A9mi=20Alvergnat?= <remi.alvergnat@gfi.fr>
Date: Fri, 5 Apr 2019 10:41:19 +0200
Subject: [PATCH] Support reverse proxy the NextCloud way
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

In some network configurations involving a reverse proxy, the base url generated by the underlying SAML library is not consistent with the way it's generated in NextCloud.

For example, it may generate `http://` urls instead of `https://` when the SSL Layer is handled by a proxy, even when NextCloud URLGenerator#getAbsoluteURL effectively generates `https://` urls.

This change setup SAML library to use the Server Protocol and Server Host as returned by the NextCloud Request object to build SAML urls properly.

Signed-off-by: RÃ©mi Alvergnat <remi.alvergnat@gfi.fr>
---
 custom_apps/user_saml/lib/SAMLSettings.php | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/lib/SAMLSettings.php b/lib/SAMLSettings.php
index 0cde99a6..6b119ca7 100644
--- a/custom_apps/user_saml/lib/SAMLSettings.php
+++ b/custom_apps/user_saml/lib/SAMLSettings.php
@@ -27,6 +27,7 @@
 use OCP\ISession;
 use OCP\IURLGenerator;
 use OneLogin\Saml2\Constants;
+use OneLogin\Saml2\Utils;

 class SAMLSettings {
 	/** @var IURLGenerator */
@@ -54,6 +55,11 @@ public function __construct(IURLGenerator $urlGenerator,
 		$this->config = $config;
 		$this->request = $request;
 		$this->session = $session;
+
+		Utils::setSelfProtocol($this->request->getServerProtocol());
+		Utils::setSelfHost($this->request->getServerHost());
+		Utils::setSelfPort(null);
+		Utils::setProxyVars(true);
 	}

 	/**